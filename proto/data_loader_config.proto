syntax = "proto2";

package lczero.training;

// Configuration for file path provider that watches directories for new
// training files. Maps to FilePathProviderOptions in
// csrc/loader/chunk_feed/file_path_provider.h
message FilePathProviderConfig {
  // Size of the internal file queue.
  optional uint64 queue_capacity = 1 [default = 16];
  // Path to directory containing training data files.
  optional string directory = 2;
}

// Configuration for chunk source loader that converts file paths to chunk
// sources. Maps to ChunkSourceLoaderOptions in
// csrc/loader/chunk_feed/chunk_source_loader.h
message ChunkSourceLoaderConfig {
  // Name of the stage providing input to this loader.
  optional string input = 1;
  // Number of worker threads for loading.
  optional uint64 threads = 2 [default = 1];
  // Size of the output queue.
  optional uint64 queue_capacity = 3 [default = 16];
}

// Configuration for shuffling chunk pool that manages chunk shuffling and
// loading. Maps to ShufflingChunkPoolOptions in
// csrc/loader/chunk_feed/shuffling_chunk_pool.h
message ShufflingChunkPoolConfig {
  // Name of the stage providing input to this pool.
  optional string input = 1;
  // Size of the chunk shuffle buffer.
  optional uint64 chunk_pool_size = 2 [default = 100000];
  // Threads for ingesting new chunk sources (lightweight).
  optional uint64 source_ingestion_threads = 4 [default = 1];
  // Threads for loading chunk data.
  optional uint64 chunk_loading_threads = 5 [default = 4];
  // Size of the output queue.
  optional uint64 queue_capacity = 6 [default = 16];
  // When set to a positive value, enable Hanse single-position sampling.
  // Probability to accept a chunk is
  //   min(1.0, num_records / hanse_sampling_threshold) ** hanse_sampling_gamma
  // where num_records is the number of frames in the chunk.
  optional uint64 hanse_sampling_threshold = 7;  // by default, disabled.
  optional double hanse_sampling_gamma = 8 [default = 1.0];
}

// Configuration for chunk rescorer that adjusts chunk metadata using
// tablebases. Maps to ChunkRescorerOptions in
// csrc/loader/stages/chunk_rescorer.h
message ChunkRescorerConfig {
  // Name of the stage providing input to this rescorer.
  optional string input = 1;
  // Number of worker threads for rescoring.
  optional uint64 threads = 2 [default = 1];
  // Size of the output queue.
  optional uint64 queue_capacity = 3 [default = 16];
  // Comma-separated list of Syzygy tablebase directories.
  optional string syzygy_paths = 4;
  // Policy reshaping temperature.
  optional float dist_temp = 5 [default = 1.0];
  // Policy offset applied during rescoring.
  optional float dist_offset = 6 [default = 0.0];
  // DTZ boost factor when policy adjustments apply.
  optional float dtz_boost = 7 [default = 0.0];
  // Optional conversion target for input format (-1 keeps original).
  optional int32 new_input_format = 8 [default = -1];
  // Optional deblunder threshold for policy adjustments.
  optional float deblunder_threshold = 9;
  // Optional deblunder width controlling smoothing around the threshold.
  optional float deblunder_width = 10;
}

// Configuration for chunk unpacker that extracts frames from packed chunks.
// Maps to ChunkUnpackerOptions in csrc/loader/chunk_feed/chunk_unpacker.h
message ChunkUnpackerConfig {
  // Name of the stage providing input to this unpacker.
  optional string input = 1;
  // Number of worker threads for unpacking.
  optional uint64 threads = 2 [default = 1];
  // Probability of sampling each position within a chunk.
  optional float position_sampling_rate = 3 [default = 1.0];
  // Number of positions to take from each chunk.
  optional uint32 position_count = 4;
  // Size of the output queue.
  optional uint64 queue_capacity = 5 [default = 16];
}

// Configuration for shuffling frame sampler using reservoir sampling.
// Maps to ShufflingFrameSamplerOptions in csrc/loader/shuffling_frame_sampler.h
message ShufflingFrameSamplerConfig {
  // Name of the stage providing input to this sampler.
  optional string input = 1;
  // Number of worker threads.
  optional uint64 threads = 2 [default = 1];
  // Size of sampling reservoir per thread.
  optional uint64 reservoir_size_per_thread = 3 [default = 1000000];
  // Size of the output queue.
  optional uint64 queue_capacity = 4 [default = 16];
}

// Configuration for tensor generator that converts frames to batched tensors.
// Maps to TensorGeneratorOptions in csrc/loader/tensor_generator.h
message TensorGeneratorConfig {
  // Queue overflow behavior.
  enum OverflowBehavior {
    BLOCK = 0;
    DROP_NEW = 1;
    KEEP_NEWEST = 2;
  }

  // Name of the stage providing input to this generator.
  optional string input = 1;
  // Number of worker threads for tensor generation.
  optional uint64 threads = 2 [default = 1];
  // Batch size for tensor generation.
  optional uint64 batch_size = 3 [default = 1024];
  // Size of the output queue.
  optional uint64 queue_capacity = 4 [default = 4];
  // Overflow behavior of the output queue.
  optional OverflowBehavior overflow_behavior = 5;
}

// Configuration for a stage that splits incoming ChunkSources into several
// outputs based on a deterministic hash of (chunk source name, index within
// source). For each configured output, provides a name, weight that controls
// the proportion of indices assigned to it, and queue parameters.
message ChunkSourceSplitterConfig {
  // Name of the upstream stage producing ChunkSourceWithPhase.
  optional string input = 1;

  // Queue overflow behavior.
  enum OverflowBehavior {
    BLOCK = 0;
    DROP_NEW = 1;
    KEEP_NEWEST = 2;
  }

  message OutputConfig {
    // Name of this output (referenced as "<stage>.<name>").
    optional string name = 1;
    // Relative weight used for hash-based assignment.
    optional uint64 weight = 2 [default = 1];
    // Capacity of the output queue.
    optional uint64 queue_capacity = 3 [default = 16];
    // Overflow behavior of the output queue.
    optional OverflowBehavior overflow_behavior = 4;
  }

  // List of outputs to produce.
  repeated OutputConfig output = 2;
}

// Configuration for simple chunk shuffler that processes one chunk source at a
// time and outputs all chunks in shuffled order.
message SimpleChunkShufflerConfig {
  // Name of the stage providing input to this shuffler.
  optional string input = 1;
  // Size of the output queue.
  optional uint64 queue_capacity = 2 [default = 16];
}

// Stage-level configuration providing a name and stage-specific options.
message StageConfig {
  // Unique name used to reference the stage output.
  optional string name = 1;
  optional FilePathProviderConfig file_path_provider = 2;
  optional ChunkSourceLoaderConfig chunk_source_loader = 3;
  optional ShufflingChunkPoolConfig shuffling_chunk_pool = 4;
  optional ChunkUnpackerConfig chunk_unpacker = 5;
  optional ShufflingFrameSamplerConfig shuffling_frame_sampler = 6;
  optional TensorGeneratorConfig tensor_generator = 7;
  optional ChunkRescorerConfig chunk_rescorer = 8;
  optional ChunkSourceSplitterConfig chunk_source_splitter = 9;
  optional SimpleChunkShufflerConfig simple_chunk_shuffler = 10;
}

// Main configuration class for the DataLoader containing all component
// configurations.
message DataLoaderConfig {
  // Ordered list of stage configurations comprising the pipeline.
  repeated StageConfig stage = 1;
  // Exposed outputs, each with an optional alias used by clients to fetch
  // data. Expected format: "alias:stage.output", where "alias:" and ".output"
  // are optional.
  repeated string output = 2;
}
